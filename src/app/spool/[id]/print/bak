"use client";

import { useState, useEffect, useMemo, useRef, useCallback } from "react";
import { QRCodeSVG } from "qrcode.react";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Download } from "lucide-react";
import { toPng } from "html-to-image";
import localFont from "next/font/local";

const lxgwFont = localFont({
  src: "../../../../../fonts/LXGWNeoXiHeiScreenFull.ttf",
  display: "swap",
});

// --- Types ---

interface GlobalFilament {
  brand: string;
  material: string;
  color_name: string;
  color_hex: string | null;
  logo_url: string | null;
  nozzle_temp: string | null;
  bed_temp: string | null;
  print_speed: string | null;
  density: string | null;
  diameter: string | null;
  nominal_weight: string | null;
  softening_temp: string | null;
  chamber_temp: string | null;
  pressure_advance: string | null;
  shrinkage: string | null;
  fan_min: string | null;
  fan_max: string | null;
  max_volumetric_speed: string | null;
  flow_ratio: string | null;
  drying_temp: string | null;
  dry_time: string | null;
  ams_compatibility: string | null;
  build_plates: string | null;
  top_voted_td: string | null;
}

interface LabelParam {
  key: keyof GlobalFilament;
  label: string;
  category: string;
  defaultOn: boolean;
  unit?: string;
}

// --- Param config (Chinese labels) ---

const LABEL_PARAMS: LabelParam[] = [
  { key: "color_name", label: "颜色", category: "基本信息", defaultOn: true },
  { key: "nozzle_temp", label: "喷嘴温度", category: "打印参数", defaultOn: true },
  { key: "bed_temp", label: "热床温度", category: "打印参数", defaultOn: true },
  { key: "print_speed", label: "打印速度", category: "打印参数", defaultOn: true, unit: "mm/s" },
  { key: "flow_ratio", label: "流量比", category: "流量特性", defaultOn: false },
  { key: "top_voted_td", label: "TD值", category: "流量特性", defaultOn: false },
  { key: "max_volumetric_speed", label: "最大体积速度", category: "流量特性", defaultOn: false, unit: "mm³/s" },
  { key: "density", label: "密度", category: "技术参数", defaultOn: false, unit: "g/cm³" },
  { key: "diameter", label: "直径", category: "技术参数", defaultOn: false, unit: "mm" },
  { key: "nominal_weight", label: "标称重量", category: "技术参数", defaultOn: false, unit: "g" },
  { key: "softening_temp", label: "软化温度", category: "技术参数", defaultOn: false },
  { key: "chamber_temp", label: "腔体温度", category: "技术参数", defaultOn: false },
  { key: "pressure_advance", label: "压力提前", category: "技术参数", defaultOn: false },
  { key: "shrinkage", label: "收缩率", category: "技术参数", defaultOn: false, unit: "%" },
  { key: "fan_min", label: "最小风扇", category: "风扇速度", defaultOn: false, unit: "%" },
  { key: "fan_max", label: "最大风扇", category: "风扇速度", defaultOn: false, unit: "%" },
  { key: "drying_temp", label: "干燥温度", category: "干燥信息", defaultOn: false },
  { key: "dry_time", label: "干燥时间", category: "干燥信息", defaultOn: false, unit: "h" },
  { key: "ams_compatibility", label: "AMS兼容", category: "兼容性", defaultOn: false },
  { key: "build_plates", label: "打印板", category: "兼容性", defaultOn: false },
];

const STORAGE_KEY = "spool-label-selected-params";

// --- Component ---

interface SpoolLabelPrinterProps {
  globalFilament: GlobalFilament;
  qrUrl: string;
}

const MAX_SLOTS = 4;
const DEFAULT_SLOTS: (keyof GlobalFilament)[] = ["color_name", "nozzle_temp", "bed_temp", "print_speed"];

export function SpoolLabelPrinter({ globalFilament: gf, qrUrl }: SpoolLabelPrinterProps) {
  const labelRef = useRef<HTMLDivElement>(null);

  const availableParams = useMemo(
    () => LABEL_PARAMS.filter((p) => gf[p.key] != null && gf[p.key] !== ""),
    [gf]
  );

  // 4 slots, each holds a param key or "_none"
  const [slots, setSlots] = useState<string[]>(() => {
    return DEFAULT_SLOTS.map((k) =>
      availableParams.some((p) => p.key === k) ? k : "_none"
    );
  });

  useEffect(() => {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        const keys: string[] = JSON.parse(stored);
        // Pad to MAX_SLOTS
        const padded = Array.from({ length: MAX_SLOTS }, (_, i) => keys[i] ?? "_none");
        setSlots(padded);
      }
    } catch {}
  }, []);

  useEffect(() => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(slots));
    } catch {}
  }, [slots]);

  const updateSlot = (index: number, value: string) => {
    setSlots((prev) => {
      const next = [...prev];
      next[index] = value;
      return next;
    });
  };

  // Build display rows from slots (skip "_none")
  const displayRows = useMemo(() => {
    const rows: { label: string; value: string }[] = [];
    for (const key of slots) {
      if (key === "_none") continue;
      const param = LABEL_PARAMS.find((p) => p.key === key);
      if (!param) continue;
      const raw = String(gf[param.key] ?? "");
      if (!raw) continue;
      const unit = param.unit && !raw.includes(param.unit) ? param.unit : "";
      rows.push({ label: param.label, value: `${raw}${unit}` });
    }
    return rows;
  }, [slots, gf]);

  const handleDownload = useCallback(async () => {
    if (!labelRef.current) return;
    try {
      const dataUrl = await toPng(labelRef.current, {
        pixelRatio: 4,
        backgroundColor: "#ffffff",
        fetchRequestInit: { mode: "cors" },
        skipFonts: true,
      });
      const link = document.createElement("a");
      link.download = `${gf.brand}-${gf.material}-${gf.color_name}.png`;
      link.href = dataUrl;
      link.click();
    } catch (err) {
      console.error("Failed to export label:", err);
    }
  }, [gf.brand, gf.material, gf.color_name]);

  // Layout constants (SVG viewBox 400x300) — matches wireframe
  const VB_W = 400;
  const VB_H = 300;
  const PAD = 16;

  // QR code (top-right)
  const QR_SIZE = 130;
  const QR_X = 251;
  const QR_Y = 18;

  // Brand logo area: fixed region, logo scales to fit
  const LOGO_Y = 18;
  const LOGO_W = 220;
  const LOGO_H = 70;

  // Material bar (black)
  const BAR_Y = 103;
  const BAR_W = 220;
  const BAR_H = 45;

  // Param area: large bottom region
  const PARAM_AREA_TOP = 163;
  const PARAM_AREA_H = 125;
  const PARAM_LINE_H = 28;
  const PARAM_FONT = 24;
  const PARAM_VAL_X = 150;

  // Build display rows: color_name as first row, then selected params
  const displayRows: { label: string; value: string }[] = [];
  displayRows.push({ label: "颜色", value: gf.color_name });
  for (const p of activeParams) {
    const val = String(gf[p.key] ?? "");
    const unit = p.unit && !val.includes(p.unit) ? p.unit : "";
    displayRows.push({ label: p.label, value: `${val}${unit}` });
  }

  // Dynamic line height
  const lineH = displayRows.length > 7 ? 20 : PARAM_LINE_H;

  return (
    <>
      {/* Control panel */}
      <div style={{ padding: "16px 0", maxWidth: "800px" }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", gap: "16px", flexWrap: "wrap" }}>
          <div style={{ flex: 1, minWidth: "300px" }}>
            <h3 style={{ fontSize: "14px", fontWeight: 600, marginBottom: "12px", color: "#333" }}>
              选择要显示的参数
            </h3>
            <div style={{ display: "flex", flexWrap: "wrap", gap: "16px" }}>
              {Object.entries(groupedParams).map(([category, params]) => (
                <div key={category} style={{ minWidth: "140px" }}>
                  <div style={{ fontSize: "12px", fontWeight: 600, color: "#666", marginBottom: "6px" }}>
                    {category}
                  </div>
                  {params.map((p) => (
                    <label
                      key={p.key}
                      style={{
                        display: "flex",
                        alignItems: "center",
                        gap: "6px",
                        fontSize: "13px",
                        cursor: "pointer",
                        marginBottom: "4px",
                      }}
                    >
                      <Checkbox
                        checked={selected.has(p.key)}
                        onCheckedChange={() => toggleParam(p.key)}
                      />
                      <span>{p.label}</span>
                    </label>
                  ))}
                </div>
              ))}
            </div>
          </div>
          <Button onClick={handleDownload} size="lg" style={{ marginTop: "4px" }}>
            <Download className="size-4" />
            下载标签图片
          </Button>
        </div>
      </div>

      {/* Label preview */}
      <div style={{ display: "flex", justifyContent: "center", padding: "8px 0" }}>
        <div
          ref={labelRef}
          style={{
            width: "400px",
            aspectRatio: "4/3",
            background: "#fff",
            borderRadius: "12px",
            overflow: "hidden",
            boxShadow: "0 2px 8px rgba(0,0,0,0.1)",
            border: "1px solid #e5e7eb",
          }}
        >
          <svg
            viewBox={`0 0 ${VB_W} ${VB_H}`}
            xmlns="http://www.w3.org/2000/svg"
            style={{ width: "100%", height: "100%" }}
          >
            <style>{`
              text { font-family: Arial, Helvetica, sans-serif; }
              .brand-name { font-weight: bold; font-size: 36px; }
              .text-material { font-size: 30px; font-weight: bold; }
              .black-bg { fill: #000000; }
              .white-text { fill: #FFFFFF; }
            `}</style>

            {/* White background */}
            <rect width="100%" height="100%" fill="#FFFFFF" />

            {/* Brand: logo if available, text fallback */}
            {gf.logo_url ? (
              <foreignObject x={PAD} y={LOGO_Y} width={LOGO_W} height={LOGO_H}>
                <div
                  xmlns="http://www.w3.org/1999/xhtml"
                  style={{ width: "100%", height: "100%", display: "flex", alignItems: "center" }}
                >
                  <img
                    src={gf.logo_url}
                    alt={gf.brand}
                    style={{
                      height: LOGO_H,
                      maxWidth: LOGO_W,
                      objectFit: "contain",
                      objectPosition: "left center",
                      filter: "grayscale(100%) contrast(1.2)",
                    }}
                  />
                </div>
              </foreignObject>
            ) : (
              <text x={PAD} y={LOGO_Y + 42} className="brand-name">
                {gf.brand}
              </text>
            )}

            {/* QR Code (top-right) */}
            <foreignObject x={QR_X} y={QR_Y} width={QR_SIZE} height={QR_SIZE}>
              <div xmlns="http://www.w3.org/1999/xhtml" style={{ width: QR_SIZE, height: QR_SIZE, background: "#fff" }}>
                <QRCodeSVG value={qrUrl} size={QR_SIZE} level="M" includeMargin={false} />
              </div>
            </foreignObject>

            {/* Material bar (black) */}
            <rect x={PAD} y={BAR_Y} width={BAR_W} height={BAR_H} className="black-bg" />
            <text x={PAD + 4} y={BAR_Y + BAR_H - 12} className="white-text text-material">
              {gf.material}
            </text>

            {/* Parameters — rendered with LXGW font via foreignObject */}
            <foreignObject x={PAD} y={PARAM_AREA_TOP} width={VB_W - PAD * 2} height={PARAM_AREA_H}>
              <div
                xmlns="http://www.w3.org/1999/xhtml"
                className={lxgwFont.className}
                style={{
                  width: "100%",
                  height: "100%",
                  display: "flex",
                  flexDirection: "column",
                  justifyContent: "center",
                  fontSize: `${PARAM_FONT}px`,
                  fontWeight: 700,
                  color: "#000",
                  lineHeight: `${lineH}px`,
                }}
              >
                {displayRows.map((row, i) => (
                  <div key={i} style={{ display: "flex", gap: "8px" }}>
                    <span style={{ minWidth: `${PARAM_VAL_X - PAD}px`, flexShrink: 0 }}>{row.label}:</span>
                    <span style={{ fontWeight: 600 }}>{row.value}</span>
                  </div>
                ))}
              </div>
            </foreignObject>
          </svg>
        </div>
      </div>
    </>
  );
}
